<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Physiotherapy Exercise Recommendation Test Tool</title>
    <!-- SheetJS library for reading Excel files -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #34495e;
            color: white;
            border-radius: 8px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background-color: #fefefe;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.4em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .question {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #e74c3c;
            border-radius: 4px;
        }

        .question-text {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .question-code {
            font-family: monospace;
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background-color: white;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
        }

        .option:hover {
            border-color: #3498db;
            background-color: #ecf0f1;
        }

        .option.selected {
            border-color: #e74c3c;
            background-color: #fadbd8;
        }

        .input-group {
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        .input-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            display: block;
            margin-bottom: 0.5rem;
        }

        .rom-inputs {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        input[type="number"],
        select {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            width: 100%;
            font-size: 0.875rem;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
        }

        th,
        td {
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            text-align: left;
            font-size: 0.875rem;
        }

        th {
            background-color: #f9fafb;
            font-weight: 500;
            color: #374151;
        }

        td.center {
            text-align: center;
        }

        .btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn:hover:not(:disabled) {
            background-color: #229954;
        }

        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #3498db;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #2980b9;
        }

        .submit-container {
            text-align: center;
            margin-top: 40px;
            padding: 30px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .activity-section {
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        .activity-title {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }

        .knee-selection {
            margin: 30px 0;
            padding: 20px;
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
        }

        .knee-selection h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .knee-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .knee-option {
            padding: 12px 30px;
            background-color: white;
            border: 3px solid #ffc107;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .knee-option:hover {
            background-color: #fff3cd;
        }

        .knee-option.selected {
            background-color: #ffc107;
            color: white;
        }

        .algorithm-step {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            border-radius: 6px;
        }

        .step-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #bdc3c7;
        }

        .calc-detail {
            margin-bottom: 10px;
            padding: 8px 12px;
            background-color: white;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .highlight {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 5px 8px;
            border-radius: 3px;
            font-weight: bold;
        }

        .final-results {
            background-color: #27ae60;
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .final-results h3 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4em;
        }

        .exercise-result {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
        }

        .exercise-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .score-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .back-btn {
            background-color: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 20px;
        }

        .back-btn:hover {
            background-color: #7f8c8d;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background-color: #ecf0f1;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #3498db;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .subsection-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #374151;
            margin: 20px 0 15px 0;
        }

        h3.sharing-header {
            color: #e74c3c;
            margin: 20px 0 15px 0;
            font-size: 1.1em;
        }

        .muscle-breakdown-table {
            width: 100%;
            margin-top: 15px;
            font-size: 0.85em;
        }

        .muscle-breakdown-table th {
            background-color: #34495e;
            color: white;
        }

        .filter-selection {
            margin: 30px 0;
            padding: 20px;
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
        }

        .filter-selection h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-label {
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 8px;
            display: block;
        }

        .filter-help {
            font-size: 0.9em;
            color: #558b2f;
            font-style: italic;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Integrated Physiotherapy Exercise Recommendation Test Tool</h1>
            <p>Complete Algorithm Testing: Position Multiplier √ó Muscle Deficit-Recruitment Score</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar">Step 1: Questionnaire</div>
        </div>

        <!-- PAGE 1: QUESTIONNAIRE -->
        <div id="page1" class="page active">
            <form id="questionnaireForm">
                <!-- Pain Questions -->
                <div class="section">
                    <h2>Pain Questions (Used for ALL positions)</h2>
                    <p><em>These questions affect all exercise positions with 25% weight in composite scoring.</em></p>

                    <div class="question">
                        <div class="question-code">[P1]</div>
                        <div class="question-text">How often do you experience knee pain?</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="P1" value="0"> Never (0)</label>
                            <label class="option"><input type="radio" name="P1" value="1"> Monthly (1)</label>
                            <label class="option"><input type="radio" name="P1" value="2"> Weekly (2)</label>
                            <label class="option"><input type="radio" name="P1" value="3"> Daily (3)</label>
                            <label class="option"><input type="radio" name="P1" value="4"> Always (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[P2]</div>
                        <div class="question-text">Twisting/pivoting on your knee</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="P2" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="P2" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="P2" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="P2" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="P2" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[P5]</div>
                        <div class="question-text">Walking on flat surface</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="P5" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="P5" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="P5" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="P5" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="P5" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[P6]</div>
                        <div class="question-text">Going up or down stairs</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="P6" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="P6" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="P6" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="P6" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="P6" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[P9]</div>
                        <div class="question-text">Standing upright</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="P9" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="P9" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="P9" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="P9" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="P9" value="4"> Extreme (4)</label>
                        </div>
                    </div>
                </div>

                <!-- Symptom Questions -->
                <div class="section">
                    <h2>Symptom Questions (Used for ALL positions)</h2>
                    <p><em>These questions affect all exercise positions with 15% weight in composite scoring.</em></p>

                    <div class="question">
                        <div class="question-code">[S1]</div>
                        <div class="question-text">Do you have swelling in your knee?</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="S1" value="0"> Never (0)</label>
                            <label class="option"><input type="radio" name="S1" value="1"> Rarely (1)</label>
                            <label class="option"><input type="radio" name="S1" value="2"> Sometimes (2)</label>
                            <label class="option"><input type="radio" name="S1" value="3"> Often (3)</label>
                            <label class="option"><input type="radio" name="S1" value="4"> Always (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[S2]</div>
                        <div class="question-text">Do you feel grinding, hear clicking or any other type of noise when
                            your knee moves?</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="S2" value="0"> Never (0)</label>
                            <label class="option"><input type="radio" name="S2" value="1"> Rarely (1)</label>
                            <label class="option"><input type="radio" name="S2" value="2"> Sometimes (2)</label>
                            <label class="option"><input type="radio" name="S2" value="3"> Often (3)</label>
                            <label class="option"><input type="radio" name="S2" value="4"> Always (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[S3]</div>
                        <div class="question-text">Does your knee catch or hang up when moving?</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="S3" value="0"> Never (0)</label>
                            <label class="option"><input type="radio" name="S3" value="1"> Rarely (1)</label>
                            <label class="option"><input type="radio" name="S3" value="2"> Sometimes (2)</label>
                            <label class="option"><input type="radio" name="S3" value="3"> Often (3)</label>
                            <label class="option"><input type="radio" name="S3" value="4"> Always (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[S4]</div>
                        <div class="question-text">Can you straighten your knee fully?</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="S4" value="0"> Always (0)</label>
                            <label class="option"><input type="radio" name="S4" value="1"> Often (1)</label>
                            <label class="option"><input type="radio" name="S4" value="2"> Sometimes (2)</label>
                            <label class="option"><input type="radio" name="S4" value="3"> Rarely (3)</label>
                            <label class="option"><input type="radio" name="S4" value="4"> Never (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[S5]</div>
                        <div class="question-text">Can you bend your knee fully?</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="S5" value="0"> Always (0)</label>
                            <label class="option"><input type="radio" name="S5" value="1"> Often (1)</label>
                            <label class="option"><input type="radio" name="S5" value="2"> Sometimes (2)</label>
                            <label class="option"><input type="radio" name="S5" value="3"> Rarely (3)</label>
                            <label class="option"><input type="radio" name="S5" value="4"> Never (4)</label>
                        </div>
                    </div>
                </div>

                <!-- Position-Specific Core Questions -->
                <div class="section">
                    <h2>Position-Specific Core Questions (60% weight)</h2>
                    <p><em>These questions are used for different exercise positions as core ability indicators.</em>
                    </p>

                    <h3 class="sharing-header">üîó Shared by 3 positions (DL_stand, split_stand & SL_stand):</h3>

                    <div class="question">
                        <div class="question-code">[SP1] ‚Üí DL_stand, split_stand & SL_stand</div>
                        <div class="question-text">Squatting</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="SP1" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="SP1" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="SP1" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="SP1" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="SP1" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <h3 class="sharing-header">üîó Shared by split_stand & SL_stand:</h3>

                    <div class="question">
                        <div class="question-code">[F1] ‚Üí split_stand & SL_stand</div>
                        <div class="question-text">Descending stairs</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="F1" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="F1" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="F1" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="F1" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="F1" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[F2] ‚Üí split_stand & SL_stand</div>
                        <div class="question-text">Ascending stairs</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="F2" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="F2" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="F2" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="F2" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="F2" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[SP4] ‚Üí split_stand & SL_stand</div>
                        <div class="question-text">Twisting/pivoting on your injured knee</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="SP4" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="SP4" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="SP4" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="SP4" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="SP4" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <h3 class="sharing-header">üîó Shared by DL_stand & split_stand:</h3>

                    <div class="question">
                        <div class="question-code">[F3] ‚Üí DL_stand & split_stand</div>
                        <div class="question-text">Rising from sitting</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="F3" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="F3" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="F3" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="F3" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="F3" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <h3 class="sharing-header">üîó Shared by DL_stand & SL_stand:</h3>

                    <div class="question">
                        <div class="question-code">[F4] ‚Üí DL_stand & SL_stand</div>
                        <div class="question-text">Standing</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="F4" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="F4" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="F4" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="F4" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="F4" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <h3 class="sharing-header">üîó Shared by DL_stand & quadruped:</h3>

                    <div class="question">
                        <div class="question-code">[F5] ‚Üí DL_stand & quadruped</div>
                        <div class="question-text">Bending to floor/pick up an object</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="F5" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="F5" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="F5" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="F5" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="F5" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <h3 class="sharing-header">üìç DL_stand Unique Questions:</h3>

                    <div class="question">
                        <div class="question-code">[F6] ‚Üí DL_stand only</div>
                        <div class="question-text">Walking on flat surface</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="F6" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="F6" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="F6" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="F6" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="F6" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[F8] ‚Üí DL_stand only</div>
                        <div class="question-text">Going shopping</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="F8" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="F8" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="F8" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="F8" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="F8" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <h3 class="sharing-header">üìç split_stand Unique Questions:</h3>

                    <div class="question">
                        <div class="question-code">[F7] ‚Üí split_stand only</div>
                        <div class="question-text">Getting in/out of car</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="F7" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="F7" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="F7" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="F7" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="F7" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[F13] ‚Üí split_stand only</div>
                        <div class="question-text">Getting in/out of bath</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="F13" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="F13" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="F13" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="F13" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="F13" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[F15] ‚Üí split_stand only</div>
                        <div class="question-text">Getting on/off toilet</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="F15" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="F15" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="F15" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="F15" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="F15" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <h3 class="sharing-header">üìç SL_stand Unique Questions:</h3>

                    <div class="question">
                        <div class="question-code">[F9] ‚Üí SL_stand only</div>
                        <div class="question-text">Putting on socks/stockings</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="F9" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="F9" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="F9" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="F9" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="F9" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[F11] ‚Üí SL_stand only</div>
                        <div class="question-text">Taking off socks/stockings</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="F11" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="F11" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="F11" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="F11" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="F11" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[SP2] ‚Üí SL_stand only</div>
                        <div class="question-text">Running</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="SP2" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="SP2" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="SP2" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="SP2" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="SP2" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[SP3] ‚Üí SL_stand only</div>
                        <div class="question-text">Jumping</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="SP3" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="SP3" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="SP3" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="SP3" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="SP3" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <h3 class="sharing-header">üìç quadruped Unique Questions:</h3>

                    <div class="question">
                        <div class="question-code">[SP5] ‚Üí quadruped only</div>
                        <div class="question-text">Kneeling</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="SP5" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="SP5" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="SP5" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="SP5" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="SP5" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[ST2] ‚Üí quadruped only</div>
                        <div class="question-text">How severe is your knee stiffness after sitting, lying or resting
                            later in the day?</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="ST2" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="ST2" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="ST2" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="ST2" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="ST2" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[P3] ‚Üí quadruped only</div>
                        <div class="question-text">Straightening knee fully</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="P3" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="P3" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="P3" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="P3" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="P3" value="4"> Extreme (4)</label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-code">[P4] ‚Üí quadruped only</div>
                        <div class="question-text">Bending knee fully</div>
                        <div class="options">
                            <label class="option"><input type="radio" name="P4" value="0"> None (0)</label>
                            <label class="option"><input type="radio" name="P4" value="1"> Mild (1)</label>
                            <label class="option"><input type="radio" name="P4" value="2"> Moderate (2)</label>
                            <label class="option"><input type="radio" name="P4" value="3"> Severe (3)</label>
                            <label class="option"><input type="radio" name="P4" value="4"> Extreme (4)</label>
                        </div>
                    </div>
                </div>

                <div class="submit-container">
                    <button type="button" id="page1NextBtn" class="btn" disabled>Next: Assessment Form</button>
                    <p style="margin-top: 10px; color: #666;"><span id="questionnaireProgress">0/30</span> questions
                        answered</p>
                </div>
            </form>
        </div>

        <!-- PAGE 2: ASSESSMENT FORM -->
        <div id="page2" class="page">
            <form id="assessmentForm">
                <!-- Physical Examination -->
                <div class="section">
                    <h2>Physical Examination</h2>

                    <!-- Range of Movement -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 class="subsection-title">Range of Movement</h3>
                        <div class="grid-2">
                            <!-- Right Knee -->
                            <div class="input-group">
                                <label class="input-label">Right Knee</label>
                                <div class="rom-inputs">
                                    <input type="number" min="0" placeholder="Min" id="romRightMin">
                                    <span style="color: #6b7280;">-</span>
                                    <input type="number" min="0" placeholder="Max" id="romRightMax">
                                    <span style="color: #6b7280;">¬∞</span>
                                </div>
                            </div>

                            <!-- Left Knee -->
                            <div class="input-group">
                                <label class="input-label">Left Knee</label>
                                <div class="rom-inputs">
                                    <input type="number" min="0" placeholder="Min" id="romLeftMin">
                                    <span style="color: #6b7280;">-</span>
                                    <input type="number" min="0" placeholder="Max" id="romLeftMax">
                                    <span style="color: #6b7280;">¬∞</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Muscle Strength -->
                    <div>
                        <h3 class="subsection-title">Muscle Strength (Oxford Scale 0-5)</h3>

                        <!-- Knee Muscles -->
                        <h4 style="font-weight: 500; margin: 15px 0 10px 0;">Knee</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50%;">Muscle</th>
                                    <th style="width: 25%; text-align: center;">Right</th>
                                    <th style="width: 25%; text-align: center;">Left</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Quadriceps</td>
                                    <td class="center">
                                        <select id="muscleKneeQuadricepsRight">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                    <td class="center">
                                        <select id="muscleKneeQuadricepsLeft">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Hamstrings</td>
                                    <td class="center">
                                        <select id="muscleKneeHamstringsRight">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                    <td class="center">
                                        <select id="muscleKneeHamstringsLeft">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Hip Muscles -->
                        <h4 style="font-weight: 500; margin: 15px 0 10px 0;">Hip</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50%;">Muscle</th>
                                    <th style="width: 25%; text-align: center;">Right</th>
                                    <th style="width: 25%; text-align: center;">Left</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Gluteus Maximus</td>
                                    <td class="center">
                                        <select id="muscleHipGluteusMaximusRight">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                    <td class="center">
                                        <select id="muscleHipGluteusMaximusLeft">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Gluteus Medius/Minimus</td>
                                    <td class="center">
                                        <select id="muscleHipGluteusMediusMinimusRight">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                    <td class="center">
                                        <select id="muscleHipGluteusMediusMinimusLeft">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Adductors</td>
                                    <td class="center">
                                        <select id="muscleHipAdductorsRight">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                    <td class="center">
                                        <select id="muscleHipAdductorsLeft">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Hip Flexors</td>
                                    <td class="center">
                                        <select id="muscleHipHipFlexorsRight">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                    <td class="center">
                                        <select id="muscleHipHipFlexorsLeft">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Ankle Muscles -->
                        <h4 style="font-weight: 500; margin: 15px 0 10px 0;">Ankle</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50%;">Muscle</th>
                                    <th style="width: 25%; text-align: center;">Right</th>
                                    <th style="width: 25%; text-align: center;">Left</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Calves</td>
                                    <td class="center">
                                        <select id="muscleAnkleCalvesRight">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                    <td class="center">
                                        <select id="muscleAnkleCalvesLeft">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Knee Selection -->
                <div class="knee-selection">
                    <h3>Select Knee(s) for Exercise Recommendation</h3>
                    <p style="margin-bottom: 15px; color: #856404;">Choose which knee to assess for exercise
                        recommendations. Selecting "Both" will calculate separate scores for each knee.</p>
                    <div class="knee-options">
                        <div class="knee-option" data-knee="left">Left Knee</div>
                        <div class="knee-option" data-knee="right">Right Knee</div>
                        <div class="knee-option" data-knee="both">Both Knees</div>
                    </div>
                </div>

                <!-- Optional Filters -->
                <div class="filter-selection">
                    <h3>Optional Filters</h3>
                    <p style="margin-bottom: 15px; color: #2e7d32;">Customize the exercise recommendation algorithm with
                        these optional filters.</p>

                    <div class="filter-group">
                        <label class="filter-label">1. Muscle Focus (Optional)</label>
                        <select id="muscleFocus">
                            <option value="">None - Equal weight to all muscles (1/7 each)</option>
                            <option value="quadriceps">Quadriceps - Increased weight (3x = 3/13)</option>
                            <option value="hamstrings">Hamstrings - Increased weight (3x = 3/13)</option>
                            <option value="glute_max">Gluteus Maximus - Increased weight (3x = 3/13)</option>
                            <option value="glute_med_min">Gluteus Medius/Minimus - Increased weight (3x = 3/13)</option>
                            <option value="adductors">Adductors - Increased weight (3x = 3/13)</option>
                            <option value="hip_flexors">Hip Flexors - Increased weight (3x = 3/13)</option>
                            <option value="calves">Calves - Increased weight (3x = 3/13)</option>
                        </select>
                        <div class="filter-help">
                            Selecting a muscle gives it 3x weight. Other muscles get 1x weight.
                            Total: (3 + 6√ó1) = 13, so focused muscle = 3/13 ‚âà 23%, others = 1/13 ‚âà 7.7% each.
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">2. Maximum Difficulty Level (Optional)</label>
                        <select id="maxDifficulty">
                            <option value="">No limit - Show all exercises</option>
                            <option value="1">Level 1 (Easiest)</option>
                            <option value="2">Level 2</option>
                            <option value="3">Level 3</option>
                            <option value="4">Level 4</option>
                            <option value="5">Level 5 (Hardest)</option>
                        </select>
                        <div class="filter-help">
                            Filter out exercises above this difficulty level. Leave as "No limit" to show all exercises.
                        </div>
                    </div>
                </div>

                <div class="submit-container">
                    <button type="button" id="page2BackBtn" class="btn-secondary btn">‚Üê Back to Questionnaire</button>
                    <button type="button" id="page2NextBtn" class="btn" disabled>Calculate Results</button>
                    <p style="margin-top: 10px; color: #666;"><span id="assessmentProgress">Incomplete</span></p>
                </div>
            </form>
        </div>

        <!-- PAGE 3: RESULTS -->
        <div id="page3" class="page">
            <div id="resultsContainer"></div>
            <div class="submit-container">
                <button type="button" id="page3BackBtn" class="back-btn">‚Üê Back to Assessment</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // GLOBAL STATE
        // ========================================
        const state = {
            questionnaire: {},
            assessment: {
                rom: { right: {}, left: {} },
                muscle: {},
                functional: {}
            },
            selectedKnee: null,
            muscleFocus: null,
            maxDifficulty: null,
            currentPage: 1
        };

        const requiredQuestions = ['P1', 'P2', 'P5', 'P6', 'P9', 'S1', 'S2', 'S3', 'S4', 'S5',
            'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F11', 'F13', 'F15',
            'SP1', 'SP2', 'SP3', 'SP4', 'SP5', 'ST2', 'P3', 'P4'];

        // Position definitions (from questionnaire)
        const positions = {
            DL_stand: {
                name: 'Double Leg Stand',
                core: ['F3', 'F4', 'F5', 'F6', 'F8', 'SP1'],
                pain: ['P1', 'P2', 'P5', 'P6', 'P9'],
                symptoms: ['S1', 'S2', 'S3', 'S4', 'S5']
            },
            split_stand: {
                name: 'Split Stand',
                core: ['F1', 'F2', 'F3', 'F7', 'F13', 'F15', 'SP1', 'SP4'],
                pain: ['P1', 'P2', 'P5', 'P6', 'P9'],
                symptoms: ['S1', 'S2', 'S3', 'S4', 'S5']
            },
            SL_stand: {
                name: 'Single Leg Stand',
                core: ['F1', 'F2', 'F4', 'F9', 'F11', 'SP1', 'SP2', 'SP3', 'SP4'],
                pain: ['P1', 'P2', 'P5', 'P6', 'P9'],
                symptoms: ['S1', 'S2', 'S3', 'S4', 'S5']
            },
            quadruped: {
                name: 'Quadruped',
                core: ['F5', 'SP5', 'ST2', 'P3', 'P4'],
                pain: ['P1', 'P2', 'P5', 'P6', 'P9'],
                symptoms: ['S1', 'S2', 'S3', 'S4', 'S5']
            }
        };

        // Exercise database - will be loaded from Excel file
        let exerciseDatabase = [];

        // ========================================
        // EXCEL FILE LOADING
        // ========================================
        async function loadExerciseDatabase() {
            return new Promise((resolve, reject) => {
                // Create overlay
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100vw';
                overlay.style.height = '100vh';
                overlay.style.backgroundColor = 'rgba(0,0,0,0.7)';
                overlay.style.display = 'flex';
                overlay.style.flexDirection = 'column';
                overlay.style.justifyContent = 'center';
                overlay.style.alignItems = 'center';
                overlay.style.zIndex = '9999';
                overlay.style.color = 'white';
                overlay.style.fontSize = '1.2em';
                overlay.style.textAlign = 'center';

                // Message
                const message = document.createElement('p');
                message.textContent = 'Please upload the exercise database Excel file (e.g. OA_Knee_Exercise_Database.xlsx) to begin.';
                message.style.marginBottom = '20px';

                // File input
                const uploadInput = document.createElement('input');
                uploadInput.type = 'file';
                uploadInput.accept = '.xlsx, .xls';
                uploadInput.style.padding = '10px';
                uploadInput.style.background = 'white';
                uploadInput.style.color = 'black';
                uploadInput.style.borderRadius = '6px';
                uploadInput.style.cursor = 'pointer';

                overlay.appendChild(message);
                overlay.appendChild(uploadInput);
                document.body.appendChild(overlay);

                // Handle upload
                uploadInput.addEventListener('change', event => {
                    const file = event.target.files[0];
                    if (!file) {
                        alert('No file selected.');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = e => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);

                            exerciseDatabase = jsonData.map(row => ({
                                name: row.exercise_name,
                                position_SL_stand: row.position_SL_stand,
                                position_split_stand: row.position_split_stand,
                                position_DL_stand: row.position_DL_stand,
                                position_quadruped: row.position_quadruped,
                                position_lying: row.position_lying,
                                muscle_quad: row.muscle_quad || 0,
                                muscle_hamstring: row.muscle_hamstring || 0,
                                muscle_glute_max: row.muscle_glute_max || 0,
                                muscle_glute_med_min: row.muscle_glute_med_min || 0,
                                muscle_adductors: row.muscle_adductors || 0,
                                muscle_hip_flexors: row.muscle_hip_flexors || 0,
                                muscle_calves: row.muscle_calves || 0,
                                difficulty: row.difficulty_level || 0
                            }));

                            console.log(`‚úì Loaded ${exerciseDatabase.length} exercises from uploaded file`);

                            // Remove overlay
                            document.body.removeChild(overlay);

                            resolve(true);
                        } catch (err) {
                            alert('Error reading Excel file: ' + err.message);
                            reject(err);
                        }
                    };

                    reader.readAsArrayBuffer(file);
                });
            });
        }


        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', async function () {
            // Show loading message
            const progressBar = document.getElementById('progressBar');
            progressBar.textContent = 'Loading exercise database...';
            progressBar.style.backgroundColor = '#f39c12';

            // Load exercise database from Excel
            const loaded = await loadExerciseDatabase();

            if (loaded) {
                progressBar.textContent = 'Step 1: Questionnaire';
                progressBar.style.backgroundColor = '#3498db';

                setupQuestionnaireListeners();
                setupAssessmentListeners();
                setupNavigationListeners();
            } else {
                progressBar.textContent = 'Error: Could not load exercise database';
                progressBar.style.backgroundColor = '#e74c3c';
                // Disable the form
                document.getElementById('page1NextBtn').disabled = true;
            }
        });

        // ========================================
        // PAGE 1: QUESTIONNAIRE
        // ========================================
        function setupQuestionnaireListeners() {
            const radioButtons = document.querySelectorAll('#questionnaireForm input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function () {
                    state.questionnaire[this.name] = parseInt(this.value);
                    updateQuestionnaireProgress();

                    // Visual feedback
                    const options = this.closest('.options').querySelectorAll('.option');
                    options.forEach(opt => opt.classList.remove('selected'));
                    this.closest('.option').classList.add('selected');
                });
            });
        }

        function updateQuestionnaireProgress() {
            const answered = Object.keys(state.questionnaire).length;
            const total = requiredQuestions.length;

            document.getElementById('questionnaireProgress').textContent = `${answered}/${total}`;

            const btn = document.getElementById('page1NextBtn');
            btn.disabled = answered < total;
            if (answered === total) {
                btn.textContent = 'Next: Assessment Form';
            } else {
                btn.textContent = `Next: Assessment Form (${answered}/${total})`;
            }
        }

        // ========================================
        // PAGE 2: ASSESSMENT FORM
        // ========================================
        function setupAssessmentListeners() {
            // ROM inputs
            ['romRightMin', 'romRightMax', 'romLeftMin', 'romLeftMax'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateAssessmentProgress);
            });

            // Muscle strength selects
            const muscleInputs = {
                'muscleKneeQuadricepsRight': ['knee', 'quadriceps', 'right'],
                'muscleKneeQuadricepsLeft': ['knee', 'quadriceps', 'left'],
                'muscleKneeHamstringsRight': ['knee', 'hamstrings', 'right'],
                'muscleKneeHamstringsLeft': ['knee', 'hamstrings', 'left'],
                'muscleHipGluteusMaximusRight': ['hip', 'gluteus_maximus', 'right'],
                'muscleHipGluteusMaximusLeft': ['hip', 'gluteus_maximus', 'left'],
                'muscleHipGluteusMediusMinimusRight': ['hip', 'gluteus_medius_minimus', 'right'],
                'muscleHipGluteusMediusMinimusLeft': ['hip', 'gluteus_medius_minimus', 'left'],
                'muscleHipAdductorsRight': ['hip', 'adductors', 'right'],
                'muscleHipAdductorsLeft': ['hip', 'adductors', 'left'],
                'muscleHipHipFlexorsRight': ['hip', 'hip_flexors', 'right'],
                'muscleHipHipFlexorsLeft': ['hip', 'hip_flexors', 'left'],
                'muscleAnkleCalvesRight': ['ankle', 'calves', 'right'],
                'muscleAnkleCalvesLeft': ['ankle', 'calves', 'left']
            };

            Object.keys(muscleInputs).forEach(id => {
                document.getElementById(id).addEventListener('change', function (e) {
                    const [category, muscle, side] = muscleInputs[id];
                    if (!state.assessment.muscle[category]) state.assessment.muscle[category] = {};
                    if (!state.assessment.muscle[category][muscle]) state.assessment.muscle[category][muscle] = {};
                    state.assessment.muscle[category][muscle][side] = e.target.value === '' ? null : Number(e.target.value);
                    updateAssessmentProgress();
                });
            });

            // Knee selection
            document.querySelectorAll('.knee-option').forEach(option => {
                option.addEventListener('click', function () {
                    document.querySelectorAll('.knee-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    state.selectedKnee = this.dataset.knee;
                    updateAssessmentProgress();
                });
            });

            // Optional filters
            document.getElementById('muscleFocus').addEventListener('change', function (e) {
                state.muscleFocus = e.target.value === '' ? null : e.target.value;
            });

            document.getElementById('maxDifficulty').addEventListener('change', function (e) {
                state.maxDifficulty = e.target.value === '' ? null : Number(e.target.value);
            });
        }

        function updateAssessmentProgress() {
            // Check ROM
            const romComplete =
                document.getElementById('romRightMin').value !== '' &&
                document.getElementById('romRightMax').value !== '' &&
                document.getElementById('romLeftMin').value !== '' &&
                document.getElementById('romLeftMax').value !== '';

            // Check muscle strength
            let muscleComplete = true;
            ['knee', 'hip', 'ankle'].forEach(category => {
                if (!state.assessment.muscle[category]) muscleComplete = false;
            });

            const isComplete = romComplete && muscleComplete && state.selectedKnee !== null;

            document.getElementById('page2NextBtn').disabled = !isComplete;
            document.getElementById('assessmentProgress').textContent = isComplete ? 'Complete - Ready to calculate' : 'Incomplete - please fill all fields';
        }

        // ========================================
        // NAVIGATION
        // ========================================
        function setupNavigationListeners() {
            document.getElementById('page1NextBtn').addEventListener('click', () => goToPage(2));
            document.getElementById('page2BackBtn').addEventListener('click', () => goToPage(1));
            document.getElementById('page2NextBtn').addEventListener('click', calculateAndShowResults);
            document.getElementById('page3BackBtn').addEventListener('click', () => goToPage(2));
        }

        function goToPage(pageNum) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page${pageNum}`).classList.add('active');
            state.currentPage = pageNum;

            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            if (pageNum === 1) {
                progressBar.style.width = '33%';
                progressBar.textContent = 'Step 1: Questionnaire';
            } else if (pageNum === 2) {
                progressBar.style.width = '66%';
                progressBar.textContent = 'Step 2: Assessment';
            } else {
                progressBar.style.width = '100%';
                progressBar.textContent = 'Step 3: Results';
            }

            window.scrollTo(0, 0);
        }

        // ========================================
        // CALCULATION ALGORITHMS
        // ========================================

        // Step 1: Calculate Position Multipliers
        function calculatePositionMultipliers() {
            const painQuestions = ['P1', 'P2', 'P5', 'P6', 'P9'];
            const symptomQuestions = ['S1', 'S2', 'S3', 'S4', 'S5'];

            const pain_avg = painQuestions.reduce((sum, q) => sum + state.questionnaire[q], 0) / painQuestions.length;
            const symptoms_avg = symptomQuestions.reduce((sum, q) => sum + state.questionnaire[q], 0) / symptomQuestions.length;

            const positionResults = {};
            let compositeScores = [];

            for (let [posKey, posData] of Object.entries(positions)) {
                const coreAvg = posData.core.reduce((sum, q) => sum + state.questionnaire[q], 0) / posData.core.length;
                const composite = (coreAvg * 0.6) + (pain_avg * 0.25) + (symptoms_avg * 0.15);
                const multiplier = (4 - composite) / 4;

                positionResults[posKey] = {
                    name: posData.name,
                    core_questions: posData.core,
                    core_avg: coreAvg,
                    composite: composite,
                    multiplier: multiplier
                };

                compositeScores.push(composite);
            }

            const best_active_score = Math.min(...compositeScores);
            const lying_penalty = best_active_score / 4;
            const lying_multiplier = Math.max(0.1, 1.0 - lying_penalty);

            return {
                pain_avg,
                symptoms_avg,
                positions: positionResults,
                best_active_score,
                lying_multiplier
            };
        }

        // Step 2: Calculate Deficit-Recruitment Score
        function calculateDeficitRecruitmentScore(side) {
            // Extract muscle strength for selected side
            const muscleStrength = {
                quadriceps: state.assessment.muscle.knee.quadriceps[side],
                hamstrings: state.assessment.muscle.knee.hamstrings[side],
                glute_max: state.assessment.muscle.hip.gluteus_maximus[side],
                glute_med_min: state.assessment.muscle.hip.gluteus_medius_minimus[side],
                adductors: state.assessment.muscle.hip.adductors[side],
                hip_flexors: state.assessment.muscle.hip.hip_flexors[side],
                calves: state.assessment.muscle.ankle.calves[side]
            };

            // Calculate muscle weights based on focus
            let MUSCLE_WEIGHTS;
            if (state.muscleFocus) {
                // Focused muscle gets 3x weight, others get 1x weight
                // Total = 3 + 6√ó1 = 13
                MUSCLE_WEIGHTS = {
                    quadriceps: state.muscleFocus === 'quadriceps' ? 3 / 13 : 1 / 13,
                    hamstrings: state.muscleFocus === 'hamstrings' ? 3 / 13 : 1 / 13,
                    glute_max: state.muscleFocus === 'glute_max' ? 3 / 13 : 1 / 13,
                    glute_med_min: state.muscleFocus === 'glute_med_min' ? 3 / 13 : 1 / 13,
                    adductors: state.muscleFocus === 'adductors' ? 3 / 13 : 1 / 13,
                    hip_flexors: state.muscleFocus === 'hip_flexors' ? 3 / 13 : 1 / 13,
                    calves: state.muscleFocus === 'calves' ? 3 / 13 : 1 / 13
                };
            } else {
                // Equal weights for all muscles (1/7 each)
                MUSCLE_WEIGHTS = {
                    quadriceps: 1 / 7,
                    hamstrings: 1 / 7,
                    glute_max: 1 / 7,
                    glute_med_min: 1 / 7,
                    adductors: 1 / 7,
                    hip_flexors: 1 / 7,
                    calves: 1 / 7
                };
            }

            // Map muscle names to exercise database columns
            const muscleToColumn = {
                quadriceps: 'muscle_quad',
                hamstrings: 'muscle_hamstring',
                glute_max: 'muscle_glute_max',
                glute_med_min: 'muscle_glute_med_min',
                adductors: 'muscle_adductors',
                hip_flexors: 'muscle_hip_flexors',
                calves: 'muscle_calves'
            };

            const exerciseScores = [];

            for (let exercise of exerciseDatabase) {
                let totalScore = 0;
                const muscleBreakdown = {};

                for (let muscle in muscleStrength) {
                    const strength = muscleStrength[muscle];
                    const deficit = 5 - strength;
                    const recruitment = exercise[muscleToColumn[muscle]] || 0;
                    const rawScore = deficit * recruitment;
                    const normalized = rawScore / 25.0;
                    const weight = MUSCLE_WEIGHTS[muscle];
                    const weightedScore = normalized * weight;

                    totalScore += weightedScore;

                    muscleBreakdown[muscle] = {
                        strength,
                        deficit,
                        recruitment,
                        rawScore,
                        normalized,
                        weight,
                        weightedScore
                    };
                }

                exerciseScores.push({
                    name: exercise.name,
                    deficitRecruitmentScore: totalScore,
                    difficulty: exercise.difficulty,
                    muscleBreakdown,
                    // Determine primary position
                    position: exercise.position_SL_stand ? 'SL_stand' :
                        exercise.position_split_stand ? 'split_stand' :
                            exercise.position_DL_stand ? 'DL_stand' :
                                exercise.position_quadruped ? 'quadruped' : 'lying'
                });
            }

            return {
                side,
                muscleStrength,
                muscleWeights: MUSCLE_WEIGHTS,
                exerciseScores
            };
        }

        // Step 3: Calculate Final Score (Multiplier √ó Deficit-Recruitment)
        function calculateFinalScores(multiplierResults, deficitResults) {
            const finalScores = [];

            for (let exercise of deficitResults.exerciseScores) {
                // Apply difficulty filter
                if (state.maxDifficulty && exercise.difficulty > state.maxDifficulty) {
                    continue; // Skip exercises above max difficulty
                }

                const position = exercise.position;
                let multiplier;

                if (position === 'lying') {
                    multiplier = multiplierResults.lying_multiplier;
                } else {
                    multiplier = multiplierResults.positions[position]?.multiplier || 0;
                }

                const finalScore = exercise.deficitRecruitmentScore * multiplier;

                finalScores.push({
                    ...exercise,
                    multiplier,
                    finalScore
                });
            }

            // Sort by final score (descending)
            finalScores.sort((a, b) => b.finalScore - a.finalScore);

            return finalScores;
        }

        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        function getMuscleDisplayName(muscleKey) {
            const muscleNames = {
                quadriceps: 'Quadriceps',
                hamstrings: 'Hamstrings',
                glute_max: 'Gluteus Maximus',
                glute_med_min: 'Gluteus Medius/Minimus',
                adductors: 'Adductors',
                hip_flexors: 'Hip Flexors',
                calves: 'Calves'
            };
            return muscleNames[muscleKey] || muscleKey;
        }

        // ========================================
        // RESULTS DISPLAY
        // ========================================
        function calculateAndShowResults() {
            const multiplierResults = calculatePositionMultipliers();

            let resultsHTML = '<h2 style="text-align: center; margin-bottom: 30px;">Complete Algorithm Results</h2>';

            // Display filter settings
            resultsHTML += '<div style="background-color: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            resultsHTML += '<h3 style="color: #2e7d32; margin-bottom: 10px;">Applied Filters</h3>';
            resultsHTML += `<div><strong>Muscle Focus:</strong> ${state.muscleFocus ? getMuscleDisplayName(state.muscleFocus) + ' (3x weight)' : 'None - Equal weights (1/7 each)'}</div>`;
            resultsHTML += `<div><strong>Max Difficulty:</strong> ${state.maxDifficulty ? 'Level ' + state.maxDifficulty : 'No limit - All exercises'}</div>`;
            resultsHTML += '</div>';

            // If "both" knees selected, calculate for each
            if (state.selectedKnee === 'both') {
                const leftResults = calculateDeficitRecruitmentScore('left');
                const rightResults = calculateDeficitRecruitmentScore('right');

                const leftFinal = calculateFinalScores(multiplierResults, leftResults);
                const rightFinal = calculateFinalScores(multiplierResults, rightResults);

                resultsHTML += generateMultiplierSection(multiplierResults);
                resultsHTML += generateDeficitRecruitmentSection(leftResults, 'LEFT');
                resultsHTML += generateFinalScoreSection(leftFinal, multiplierResults, 'LEFT', leftResults);
                resultsHTML += '<hr style="margin: 40px 0; border: 2px solid #34495e;">';
                resultsHTML += generateDeficitRecruitmentSection(rightResults, 'RIGHT');
                resultsHTML += generateFinalScoreSection(rightFinal, multiplierResults, 'RIGHT', rightResults);
            } else {
                const deficitResults = calculateDeficitRecruitmentScore(state.selectedKnee);
                const finalScores = calculateFinalScores(multiplierResults, deficitResults);

                resultsHTML += generateMultiplierSection(multiplierResults);
                resultsHTML += generateDeficitRecruitmentSection(deficitResults, state.selectedKnee.toUpperCase());
                resultsHTML += generateFinalScoreSection(finalScores, multiplierResults, state.selectedKnee.toUpperCase(), deficitResults);
            }

            document.getElementById('resultsContainer').innerHTML = resultsHTML;
            goToPage(3);
        }

        function generateMultiplierSection(results) {
            let html = '<div class="algorithm-step">';
            html += '<div class="step-title">STEP 1: Position Multiplier Calculation</div>';

            // Shared scores
            html += '<div style="margin-bottom: 20px;">';
            html += '<h4>1.1 Shared Scores (Pain & Symptoms)</h4>';
            html += `<div class="calc-detail">Pain Average = ${results.pain_avg.toFixed(2)}</div>`;
            html += `<div class="calc-detail">Symptoms Average = ${results.symptoms_avg.toFixed(2)}</div>`;
            html += '</div>';

            // Position composite scores
            html += '<div style="margin-bottom: 20px;">';
            html += '<h4>1.2 Position Composite Scores</h4>';
            html += '<p style="font-style: italic; margin-bottom: 10px;">Formula: Composite = (Core √ó 0.6) + (Pain √ó 0.25) + (Symptoms √ó 0.15)</p>';

            for (let [key, pos] of Object.entries(results.positions)) {
                html += `<div style="margin-bottom: 15px; padding: 10px; background-color: white; border-radius: 4px;">`;
                html += `<strong>${pos.name}</strong><br>`;
                html += `Core Avg = ${pos.core_avg.toFixed(2)}<br>`;
                html += `Composite = (${pos.core_avg.toFixed(2)} √ó 0.6) + (${results.pain_avg.toFixed(2)} √ó 0.25) + (${results.symptoms_avg.toFixed(2)} √ó 0.15) = <span class="highlight">${pos.composite.toFixed(2)}</span><br>`;
                html += `Multiplier = (4 - ${pos.composite.toFixed(2)}) √∑ 4 = <span class="highlight">${pos.multiplier.toFixed(3)}</span>`;
                html += `</div>`;
            }
            html += '</div>';

            // Lying position
            html += '<div>';
            html += '<h4>1.3 Lying Position (Penalty-Based)</h4>';
            html += `<div class="calc-detail">Best Active Score = ${results.best_active_score.toFixed(2)}</div>`;
            html += `<div class="calc-detail">Lying Penalty = ${results.best_active_score.toFixed(2)} √∑ 4 = ${(results.best_active_score / 4).toFixed(3)}</div>`;
            html += `<div class="calc-detail">Lying Multiplier = max(0.1, 1.0 - ${(results.best_active_score / 4).toFixed(3)}) = <span class="highlight">${results.lying_multiplier.toFixed(3)}</span></div>`;
            html += '</div>';

            html += '</div>';
            return html;
        }

        function generateDeficitRecruitmentSection(results, sideLabel) {
            let html = '<div class="algorithm-step">';
            html += `<div class="step-title">STEP 2: Muscle Deficit-Recruitment Score (${sideLabel} Knee)</div>`;

            html += '<div style="margin-bottom: 20px;">';
            html += '<h4>2.1 Patient Muscle Strength & Weights</h4>';
            html += '<table class="muscle-breakdown-table">';
            html += '<tr><th>Muscle</th><th>Strength</th><th>Deficit (5 - Strength)</th><th>Weight</th></tr>';
            for (let [muscle, strength] of Object.entries(results.muscleStrength)) {
                const weight = results.muscleWeights[muscle];
                const weightDisplay = weight.toFixed(4) + (state.muscleFocus === muscle ? ' ‚≠ê' : '');
                html += `<tr><td>${getMuscleDisplayName(muscle)}</td><td>${strength}/5</td><td>${5 - strength}</td><td>${weightDisplay}</td></tr>`;
            }
            html += '</table>';
            if (state.muscleFocus) {
                html += '<p style="margin-top: 10px; font-style: italic; color: #2e7d32;">‚≠ê = Focused muscle with 3x increased weight (3/13 ‚âà 23%)</p>';
            }
            html += '</div>';

            html += '<div>';
            html += '<h4>2.2 Exercise Scoring Formula</h4>';
            html += '<p style="font-style: italic; margin-bottom: 10px;">For each exercise and each muscle:</p>';
            html += '<div class="calc-detail">Raw Score = Deficit √ó Recruitment</div>';
            html += '<div class="calc-detail">Normalized = Raw Score √∑ 25</div>';
            html += '<div class="calc-detail">Weighted = Normalized √ó Weight (from table above)</div>';
            html += '<div class="calc-detail">Total Score = Œ£(Weighted scores for all 7 muscles)</div>';
            if (state.maxDifficulty) {
                html += `<p style="margin-top: 10px; font-style: italic; color: #e65100;"><strong>Difficulty Filter Applied:</strong> Only showing exercises with difficulty ‚â§ ${state.maxDifficulty}</p>`;
            }
            html += '<p style="margin-top: 10px; font-style: italic; color: #666;">Top 5 exercises shown in Step 3 with detailed breakdown.</p>';
            html += '</div>';

            html += '</div>';
            return html;
        }

        function generateFinalScoreSection(finalScores, multiplierResults, sideLabel, deficitResults) {
            let html = '<div class="algorithm-step">';
            html += `<div class="step-title">STEP 3: Final Score Calculation (${sideLabel} Knee)</div>`;

            html += '<div style="margin-bottom: 20px;">';
            html += '<h4>3.1 Formula</h4>';
            html += '<div class="calc-detail">Final Score = Deficit-Recruitment Score √ó Position Multiplier</div>';
            html += '</div>';

            html += '<div>';
            html += '<h4>3.2 Top 10 Recommended Exercises</h4>';

            if (finalScores.length === 0) {
                html += '<p style="color: #d32f2f; font-weight: bold; padding: 20px; background-color: #ffebee; border-radius: 6px;">No exercises match the current filters. Try adjusting the maximum difficulty level or muscle focus.</p>';
            }

            for (let i = 0; i < Math.min(10, finalScores.length); i++) {
                const ex = finalScores[i];
                const posName = ex.position === 'lying' ? 'Lying' : multiplierResults.positions[ex.position]?.name || ex.position;

                html += `<div class="exercise-result">`;
                html += `<div class="exercise-name">#${i + 1} - ${ex.name}</div>`;
                html += `<div class="score-row"><span>Position:</span><span><strong>${posName}</strong></span></div>`;
                html += `<div class="score-row"><span>Deficit-Recruitment Score:</span><span>${ex.deficitRecruitmentScore.toFixed(4)}</span></div>`;
                html += `<div class="score-row"><span>Position Multiplier:</span><span>${ex.multiplier.toFixed(3)}</span></div>`;
                html += `<div class="score-row"><span>Final Score:</span><span class="highlight" style="font-size: 1.2em;">${ex.finalScore.toFixed(4)}</span></div>`;
                html += `<div class="score-row"><span>Difficulty Level:</span><span>${ex.difficulty}</span></div>`;

                // Muscle breakdown for top 5
                if (i < 5) {
                    html += '<details style="margin-top: 10px;"><summary style="cursor: pointer; font-weight: bold;">View Muscle Breakdown</summary>';
                    html += '<table class="muscle-breakdown-table" style="margin-top: 10px;">';
                    html += '<tr><th>Muscle</th><th>Str</th><th>Def</th><th>Rec</th><th>Raw</th><th>Norm</th><th>Wgt</th><th>Weighted</th></tr>';
                    for (let [muscle, details] of Object.entries(ex.muscleBreakdown)) {
                        html += `<tr>`;
                        html += `<td>${muscle}</td>`;
                        html += `<td>${details.strength}</td>`;
                        html += `<td>${details.deficit}</td>`;
                        html += `<td>${details.recruitment}</td>`;
                        html += `<td>${details.rawScore}</td>`;
                        html += `<td>${details.normalized.toFixed(3)}</td>`;
                        html += `<td>${details.weight.toFixed(3)}</td>`;
                        html += `<td>${details.weightedScore.toFixed(4)}</td>`;
                        html += `</tr>`;
                    }
                    html += '</table>';
                    html += '</details>';
                }

                html += `</div>`;
            }
            html += '</div>';

            html += '</div>';
            return html;
        }
    </script>
</body>

</html>